suite: test secret template
templates:
  - secret.yaml
tests:
  - it: should render secret with default values
    template: secret.yaml
    release:
      name: test-release
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: test-release-package-tracker-secrets
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: package-tracker
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: test-release
      - equal:
          path: type
          value: Opaque

  - it: should include inline secrets when provided
    template: secret.yaml
    set:
      secrets:
        uspsApiKey: "test-usps-key"
        adminApiKey: "test-admin-key"
        upsClientId: "test-ups-client"
        upsClientSecret: "test-ups-secret"
    asserts:
      - equal:
          path: data.USPS_API_KEY
          value: dGVzdC11c3BzLWtleQ== # base64 encoded "test-usps-key"
      - equal:
          path: data.ADMIN_API_KEY
          value: dGVzdC1hZG1pbi1rZXk= # base64 encoded "test-admin-key"
      - equal:
          path: data.UPS_CLIENT_ID
          value: dGVzdC11cHMtY2xpZW50 # base64 encoded "test-ups-client"
      - equal:
          path: data.UPS_CLIENT_SECRET
          value: dGVzdC11cHMtc2VjcmV0 # base64 encoded "test-ups-secret"

  - it: should include all carrier API keys when provided
    template: secret.yaml
    set:
      secrets:
        uspsApiKey: "usps-key"
        upsClientId: "ups-client"
        upsClientSecret: "ups-secret"
        fedexApiKey: "fedex-key"
        fedexSecretKey: "fedex-secret"
        dhlApiKey: "dhl-key"
    asserts:
      - equal:
          path: data.USPS_API_KEY
          value: dXNwcy1rZXk= # base64 encoded "usps-key"
      - equal:
          path: data.UPS_CLIENT_ID
          value: dXBzLWNsaWVudA== # base64 encoded "ups-client"
      - equal:
          path: data.UPS_CLIENT_SECRET
          value: dXBzLXNlY3JldA== # base64 encoded "ups-secret"
      - equal:
          path: data.FEDEX_API_KEY
          value: ZmVkZXgta2V5 # base64 encoded "fedex-key"
      - equal:
          path: data.FEDEX_SECRET_KEY
          value: ZmVkZXgtc2VjcmV0 # base64 encoded "fedex-secret"
      - equal:
          path: data.DHL_API_KEY
          value: ZGhsLWtleQ== # base64 encoded "dhl-key"

  - it: should include Gmail OAuth secrets when email is enabled
    template: secret.yaml
    set:
      email:
        enabled: true
        gmailOauth:
          clientId: "gmail-client-id"
          clientSecret: "gmail-client-secret"
          refreshToken: "gmail-refresh-token"
    asserts:
      - equal:
          path: data.GMAIL_CLIENT_ID
          value: Z21haWwtY2xpZW50LWlk # base64 encoded "gmail-client-id"
      - equal:
          path: data.GMAIL_CLIENT_SECRET
          value: Z21haWwtY2xpZW50LXNlY3JldA== # base64 encoded "gmail-client-secret"
      - equal:
          path: data.GMAIL_REFRESH_TOKEN
          value: Z21haWwtcmVmcmVzaC10b2tlbg== # base64 encoded "gmail-refresh-token"

  - it: should not include Gmail OAuth secrets when email is disabled
    template: secret.yaml
    set:
      email:
        enabled: false
        gmailOauth:
          clientId: "gmail-client-id"
          clientSecret: "gmail-client-secret"
    asserts:
      - notExists:
          path: data.GMAIL_CLIENT_ID
      - notExists:
          path: data.GMAIL_CLIENT_SECRET
      - notExists:
          path: data.GMAIL_REFRESH_TOKEN

  - it: should handle empty secret values gracefully
    template: secret.yaml
    set:
      secrets:
        uspsApiKey: ""
        adminApiKey: null
    asserts:
      - isKind:
          of: Secret
      - notExists:
          path: data.USPS_API_KEY
      - notExists:
          path: data.ADMIN_API_KEY

  - it: should support external secret references
    template: secret.yaml
    set:
      secrets:
        externalSecrets:
          uspsApiKey:
            secretName: "external-usps-secret"
            key: "api-key"
          adminApiKey:
            secretName: "external-admin-secret"
            key: "admin-key"
    asserts:
      - isKind:
          of: Secret
      # External secrets would be handled differently in deployment template
      # This test ensures the secret template still renders

  - it: should include custom secrets when provided
    template: secret.yaml
    set:
      secrets:
        customSecrets:
          CUSTOM_SECRET_1: "custom-value-1"
          CUSTOM_SECRET_2: "custom-value-2"
    asserts:
      - equal:
          path: data.CUSTOM_SECRET_1
          value: Y3VzdG9tLXZhbHVlLTE= # base64 encoded "custom-value-1"
      - equal:
          path: data.CUSTOM_SECRET_2
          value: Y3VzdG9tLXZhbHVlLTI= # base64 encoded "custom-value-2"

  - it: should render with mixed inline and external secret configurations
    template: secret.yaml
    set:
      secrets:
        uspsApiKey: "inline-usps-key"
        externalSecrets:
          adminApiKey:
            secretName: "external-admin"
            key: "key"
      email:
        enabled: true
        gmailOauth:
          clientId: "gmail-client"
    asserts:
      - equal:
          path: data.USPS_API_KEY
          value: aW5saW5lLXVzcHMta2V5 # base64 encoded "inline-usps-key"
      - equal:
          path: data.GMAIL_CLIENT_ID
          value: Z21haWwtY2xpZW50 # base64 encoded "gmail-client"